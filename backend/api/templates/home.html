<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Parking Finder</title>

  <!-- Google Fonts & Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background-color: #f0f0f0;
    }

    /* Sidebar styles */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 60px;
      height: 100%;
      background-color: #f7eaea;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    }

    .sidebar a {
      text-decoration: none;
      margin: 20px 0;
    }

    .sidebar .material-icons {
      color: #555;
      font-size: 28px;
      cursor: pointer;
    }

    /* Main content area */
    .main {
      margin-left: 60px;
      padding: 20px;
    }

    /* Search container with suggestions */
    .search-container {
      position: relative;
      display: flex;
      justify-content: center;
      margin: 0 auto;
      width: 60%;
    }

    /* Search bar */
    .search-bar {
      display: flex;
      align-items: center;
      background-color: #e9ecef;
      padding: 8px 15px;
      border-radius: 25px;
      width: 100%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .search-bar input {
      width: 100%;
      padding: 8px;
      border: none;
      background: transparent;
      font-size: 16px;
      outline: none;
    }

    .search-bar .search-icon {
      color: #666;
      font-size: 20px;
      margin-left: 8px;
      cursor: pointer;
    }

    /* Suggestions dropdown */
    .suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: background-color 0.2s;
    }

    .suggestion-item:hover,
    .suggestion-item.highlighted {
      background-color: #f8f9fa;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-icon {
      width: 20px;
      height: 20px;
      color: #666;
      flex-shrink: 0;
    }

    .suggestion-content {
      flex: 1;
    }

    .suggestion-title {
      font-weight: 500;
      color: #333;
      margin-bottom: 2px;
    }

    .suggestion-description {
      font-size: 12px;
      color: #888;
    }

    .suggestion-type {
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .suggestion-type.street {
      background-color: #e3f2fd;
      color: #1976d2;
    }

    .suggestion-type.landmark {
      background-color: #f3e5f5;
      color: #7b1fa2;
    }

    /* Loading indicator for suggestions */
    .suggestions-loading {
      padding: 12px 16px;
      text-align: center;
      color: #666;
      font-size: 14px;
    }

    /* Filters section */
    .filters {
      background-color: #d6d6d6;
      margin-top: 15px;
      padding: 15px;
      border-radius: 8px;
      line-height: 1.6;
    }

    .filter-controls {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-group label {
      font-weight: bold;
      color: #333;
    }

    .filter-group select {
      padding: 5px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
    }

    /* Summary section */
    .parking-summary {
      background-color: #e8f5e8;
      margin: 15px 0;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      color: #2e7d32;
    }

    .out-of-bounds-message {
      background-color: #ffebee;
      color: #c62828;
      margin: 15px 0;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
    }

    /* Parking card styles */
    .parking-card {
      background-color: #ffffff;
      padding: 15px 20px;
      margin: 12px 0;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: transform 0.2s ease;
    }

    .parking-card:hover {
      transform: scale(1.02);
    }

    .info-group {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .info-group strong {
      margin-bottom: 4px;
    }

    .info-group .distance-info {
      color: #666;
      font-size: 14px;
      margin-top: 4px;
    }

    .status-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-btn {
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      font-weight: bold;
      min-width: 80px;
      text-align: center;
    }
    
    .status-btn.available {
      background-color: #4caf50;
    }
    
    .status-btn.limited {
      background-color: #ff9800;
    }
    
    .status-btn.occupied {
      background-color: #f44336;
    }

    .status-btn.unknown {
      background-color: #9e9e9e;
    }

    .material-icons {
      font-size: 24px;
      vertical-align: middle;
    }
    
    .navigate-icon {
      color: #666;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .navigate-icon:hover {
      color: #2196F3;
      transform: scale(1.2);
    }

    .no-parking-message {
      padding: 2em;
      text-align: center;
      color: #888;
      font-size: 1.2em;
    }

    .loading-message {
      padding: 2em;
      text-align: center;
      color: #666;
      font-size: 1.2em;
    }

    /* Responsive tweaks */
    @media (max-width: 768px) {
      .main {
        margin-left: 0;
        padding: 10px;
      }
      .sidebar {
        display: none;
      }
      .filter-controls {
        flex-direction: column;
        align-items: flex-start;
      }
      .search-container {
        width: 90%;
      }
    }
  </style>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.querySelector('.search-bar input');
    const searchIcon = document.querySelector('.search-icon');
    const parkingContainer = document.querySelector('.parking-cards-container');
    const distanceFilter = document.getElementById('distanceFilter');
    const sortFilter = document.getElementById('sortFilter');

    let currentParkingData = [];
    let currentSearchLocation = '';
    let suggestions = [];
    let selectedSuggestionIndex = -1;
    let suggestionsTimeout;

    // Create suggestions dropdown
    const suggestionsDropdown = document.createElement('div');
    suggestionsDropdown.className = 'suggestions-dropdown';
    document.querySelector('.search-container').appendChild(suggestionsDropdown);

    // Normalize status from backend to frontend
    function normalizeStatus(statusDescription) {
      if (!statusDescription) return 'unknown';
      
      const status = statusDescription.toLowerCase();
      if (status.includes('available') || status.includes('unoccupied') || status.includes('free')) {
        return 'available';
      } else if (status.includes('occupied') || status.includes('taken') || status.includes('full')) {
        return 'occupied';
      } else if (status.includes('limited') || status.includes('partial')) {
        return 'limited';
      }
      return 'unknown';
    }

    // Get display text for status
    function getStatusText(normalizedStatus) {
      switch (normalizedStatus) {
        case 'available': return 'Available';
        case 'occupied': return 'Occupied';
        case 'limited': return 'Limited';
        default: return 'Unknown';
      }
    }

    // Get status priority for sorting (lower = higher priority)
    function getStatusPriority(normalizedStatus) {
      switch (normalizedStatus) {
        case 'available': return 1;
        case 'limited': return 2;
        case 'unknown': return 3;
        case 'occupied': return 4;
        default: return 5;
      }
    }

    // Filter and sort parking data
    function filterAndSortData(data) {
      let filtered = [...data];

      // Apply distance filter
      const maxDistance = parseFloat(distanceFilter.value);
      if (maxDistance > 0) {
        filtered = filtered.filter(spot => 
          spot.distance === '?' || parseFloat(spot.distance) <= maxDistance
        );
      }

      // Apply sorting
      const sortBy = sortFilter.value;
      filtered.sort((a, b) => {
        if (sortBy === 'availability') {
          const statusA = normalizeStatus(a.status);
          const statusB = normalizeStatus(b.status);
          const priorityA = getStatusPriority(statusA);
          const priorityB = getStatusPriority(statusB);
          
          if (priorityA !== priorityB) {
            return priorityA - priorityB;
          }
          // If same status, sort by distance
          if (a.distance !== '?' && b.distance !== '?') {
            return parseFloat(a.distance) - parseFloat(b.distance);
          }
          return 0;
        } else if (sortBy === 'distance') {
          if (a.distance === '?' && b.distance === '?') return 0;
          if (a.distance === '?') return 1;
          if (b.distance === '?') return -1;
          return parseFloat(a.distance) - parseFloat(b.distance);
        }
        return 0;
      });

      return filtered;
    }

    // Show loading message
    function showLoading() {
      const container = document.querySelector('.parking-cards-container');
      container.innerHTML = '<div class="loading-message">Searching for parking spots...</div>';
    }

    // Fetch location suggestions from backend
    async function fetchSuggestions(query) {
      if (!query || query.length < 2) {
        hideSuggestions();
        return;
      }

      try {
        showSuggestionsLoading();
        const response = await fetch(`/api/location-suggestions/?q=${encodeURIComponent(query)}`);
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        suggestions = data.suggestions || [];
        displaySuggestions(suggestions);
      } catch (error) {
        console.error('Error fetching suggestions:', error);
        hideSuggestions();
      }
    }

    // Show loading in suggestions dropdown
    function showSuggestionsLoading() {
      suggestionsDropdown.innerHTML = '<div class="suggestions-loading">Loading suggestions...</div>';
      suggestionsDropdown.style.display = 'block';
    }

    // Display suggestions in dropdown
    function displaySuggestions(suggestionsList) {
      if (!suggestionsList || suggestionsList.length === 0) {
        hideSuggestions();
        return;
      }

      let html = '';
      suggestionsList.forEach((suggestion, index) => {
        const iconName = suggestion.type === 'landmark' ? 'place' : 'location_on';
        html += `
          <div class="suggestion-item" data-index="${index}">
            <span class="material-icons suggestion-icon">${iconName}</span>
            <div class="suggestion-content">
              <div class="suggestion-title">${suggestion.text}</div>
              <div class="suggestion-description">${suggestion.description}</div>
            </div>
            <span class="suggestion-type ${suggestion.type}">${suggestion.type}</span>
          </div>
        `;
      });

      suggestionsDropdown.innerHTML = html;
      suggestionsDropdown.style.display = 'block';
      selectedSuggestionIndex = -1;

      // Add click handlers
      const suggestionItems = suggestionsDropdown.querySelectorAll('.suggestion-item');
      suggestionItems.forEach((item, index) => {
        item.addEventListener('click', () => selectSuggestion(index));
      });
    }

    // Hide suggestions dropdown
    function hideSuggestions() {
      suggestionsDropdown.style.display = 'none';
      selectedSuggestionIndex = -1;
    }

    // Select a suggestion
    function selectSuggestion(index) {
      if (index >= 0 && index < suggestions.length) {
        const suggestion = suggestions[index];
        searchInput.value = suggestion.text;
        hideSuggestions();
        
        // If suggestion has coordinates, use them directly
        if (suggestion.lat && suggestion.lng) {
          fetchNearbySpots(suggestion.lat, suggestion.lng, suggestion.text);
        } else {
          // Otherwise trigger normal search
          performSearch();
        }
      }
    }

    // Handle keyboard navigation in suggestions
    function handleSuggestionNavigation(e) {
      const suggestionItems = suggestionsDropdown.querySelectorAll('.suggestion-item');
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestionItems.length - 1);
        updateSuggestionHighlight();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
        updateSuggestionHighlight();
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selectedSuggestionIndex >= 0) {
          selectSuggestion(selectedSuggestionIndex);
        } else {
          hideSuggestions();
          performSearch();
        }
      } else if (e.key === 'Escape') {
        hideSuggestions();
      }
    }

    // Update visual highlighting of suggestions
    function updateSuggestionHighlight() {
      const suggestionItems = suggestionsDropdown.querySelectorAll('.suggestion-item');
      suggestionItems.forEach((item, index) => {
        item.classList.toggle('highlighted', index === selectedSuggestionIndex);
      });
    }

    // Live search using Django API
    async function performSearch() {
      const searchTerm = searchInput.value.trim();
      hideSuggestions();
      showLoading();

      if (searchTerm === '') {
        // Use current location
        if (!navigator.geolocation) {
          alert('Geolocation is not supported by your browser');
          return;
        }

        navigator.geolocation.getCurrentPosition(async (position) => {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;

          fetchNearbySpots(userLat, userLng, 'Your current location');
        }, () => {
          alert('Unable to retrieve your location');
        });

      } else {
        // Convert text location (e.g., "Southbank") ‚Üí coordinates
        try {
          const geoResp = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchTerm + ', Melbourne, Australia')}`
          );
          const geoData = await geoResp.json();

          if (geoData.length === 0) {
            alert('Location not found. Please try a nearby landmark.');
            return;
          }

          const userLat = parseFloat(geoData[0].lat);
          const userLng = parseFloat(geoData[0].lon);
          fetchNearbySpots(userLat, userLng, searchTerm);

        } catch (error) {
          console.error('Geocoding failed:', error);
          alert('Error finding the location. Try again.');
        }
      }
    }

    async function fetchNearbySpots(lat, lng, label) {
      try {
        const response = await fetch(`/api/spots/nearby/?lat=${lat}&lng=${lng}`);
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const data = await response.json();
        currentParkingData = data.results || [];
        currentSearchLocation = label;
        updateParkingCards();
      } catch (error) {
        console.error('Error fetching nearby spots:', error);
        alert('Failed to retrieve parking data.');
      }
    }

    // Render cards from live API data
    function updateParkingCards() {
      const container = document.querySelector('.parking-cards-container');
      const summaryContainer = document.querySelector('.parking-summary');
      const outOfBoundsContainer = document.querySelector('.out-of-bounds-message');
      
      // Clear previous content
      container.innerHTML = '';
      if (summaryContainer) {
        summaryContainer.remove();
      }
      if (outOfBoundsContainer) {
        outOfBoundsContainer.remove();
      }

      // Check if location is out of bounds
      if (currentParkingData.length === 0) {
        // Check if it's an out of bounds message from backend
        const outOfBoundsDiv = document.createElement('div');
        outOfBoundsDiv.className = 'out-of-bounds-message';
        outOfBoundsDiv.innerHTML = `
          <div>üìç Location "${currentSearchLocation}" is outside Melbourne CBD</div>
          <div style="margin-top: 8px; font-size: 14px; font-weight: normal;">
            Please search for locations within Melbourne CBD for parking data
          </div>
        `;
        container.parentNode.insertBefore(outOfBoundsDiv, container);

        container.innerHTML = `
          <div class="no-parking-message">
            No parking data available in this region
          </div>
        `;
        return;
      }

      // Filter and sort the data
      const filteredData = filterAndSortData(currentParkingData);

      // Calculate summary statistics
      const statusCounts = { available: 0, occupied: 0, limited: 0, unknown: 0 };
      filteredData.forEach(parking => {
        const normalizedStatus = normalizeStatus(parking.status);
        statusCounts[normalizedStatus]++;
      });

      // Create summary section
      const summaryDiv = document.createElement('div');
      summaryDiv.className = 'parking-summary';
      summaryDiv.innerHTML = `
        <div>Found ${filteredData.length} parking spots near ${currentSearchLocation}</div>
        <div style="margin-top: 8px; font-size: 14px;">
          <span style="color: #4caf50;">üü¢ Available: ${statusCounts.available}</span> | 
          <span style="color: #f44336;">üî¥ Occupied: ${statusCounts.occupied}</span> | 
          <span style="color: #ff9800;">üü° Limited: ${statusCounts.limited}</span>
          ${statusCounts.unknown > 0 ? ` | <span style="color: #9e9e9e;">‚ö™ Unknown: ${statusCounts.unknown}</span>` : ''}
        </div>
      `;

      // Insert summary before container
      container.parentNode.insertBefore(summaryDiv, container);

      if (filteredData.length === 0) {
        container.innerHTML = `
          <div class="no-parking-message">
            No parking spots found with current filters
          </div>
        `;
        return;
      }

      // Create parking cards
      filteredData.forEach(parking => {
        const card = document.createElement('div');
        card.className = 'parking-card';

        const normalizedStatus = normalizeStatus(parking.status);
        const statusText = getStatusText(normalizedStatus);

        // Add real-time indicator
        const now = new Date();
        const timeString = now.toLocaleTimeString();

        card.innerHTML = `
          <div class="info-group">
            <strong>${parking.address}</strong>
            <span>ID: ${parking.kerbsideid}</span>
            <span class="distance-info">Distance: ${parking.distance !== '?' ? parking.distance + ' km' : 'Unknown'}</span>
            <span style="font-size: 12px; color: #888;">Updated: ${timeString}</span>
          </div>
          <div class="status-group">
            <button class="status-btn ${normalizedStatus}">${statusText}</button>
            <span class="material-icons navigate-icon" data-lat="${parking.lat}" data-lng="${parking.lng}" data-address="${parking.address}" title="Navigate to parking">navigation</span>
          </div>
        `;

        container.appendChild(card);
      });

      addCardEvents();
    }

    // Add event handlers for filter changes
    distanceFilter.addEventListener('change', updateParkingCards);
    sortFilter.addEventListener('change', updateParkingCards);

    // Hover + dblclick + nav icons
    function addCardEvents() {
      const parkingCards = document.querySelectorAll('.parking-card');

      parkingCards.forEach(function (card) {
        card.addEventListener('dblclick', function () {
          window.location.href = 'parking-detail.html';
        });

        card.style.cursor = 'pointer';
      });

      const navigateIcons = document.querySelectorAll('.navigate-icon');
      navigateIcons.forEach(function (icon) {
        icon.addEventListener('click', function (e) {
          e.stopPropagation();
          const lat = this.dataset.lat;
          const lng = this.dataset.lng;
          const address = this.dataset.address;
          openNavigation(lat, lng, address);
        });

        icon.style.cursor = 'pointer';
      });
    }

    function openNavigation(lat, lng, address) {
      const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&destination_place_id=${encodeURIComponent(address)}`;
      window.open(googleMapsUrl, '_blank');
    }

    // Search input event handlers
    searchInput.addEventListener('input', function(e) {
      clearTimeout(suggestionsTimeout);
      const query = e.target.value.trim();
      
      if (query.length >= 2) {
        suggestionsTimeout = setTimeout(() => fetchSuggestions(query), 300); // Debounce
      } else {
        hideSuggestions();
      }
    });

    searchInput.addEventListener('keydown', handleSuggestionNavigation);

    searchInput.addEventListener('blur', function() {
      // Delay hiding to allow click on suggestions
      setTimeout(hideSuggestions, 200);
    });

    searchInput.addEventListener('focus', function() {
      const query = this.value.trim();
      if (query.length >= 2) {
        fetchSuggestions(query);
      }
    });

    // Search icon and enter key events
    searchIcon.addEventListener('click', performSearch);
    searchInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter' && selectedSuggestionIndex === -1) {
        hideSuggestions();
        performSearch();
      }
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.search-container')) {
        hideSuggestions();
      }
    });

    // Set up auto-refresh for real-time updates
    setInterval(() => {
      if (currentParkingData.length > 0) {
        // Only refresh if we have data (don't refresh empty states)
        updateParkingCards();
      }
    }, 30000); // Refresh every 30 seconds

    addCardEvents();
  });
</script>

</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <!-- Traffic Insights -->
    <a href="/traffic/" target="_blank" title="Traffic Insights">
      <span class="material-icons">map</span>
    </a>
  </div>

  <!-- Main content -->
  <div class="main">
    <!-- Search container with suggestions -->
    <div class="search-container">
      <div class="search-bar">
        <input type="text" placeholder="Search for places in Melbourne CBD..." />
        <span class="material-icons search-icon">search</span>
      </div>
      <!-- Suggestions dropdown will be added here by JavaScript -->
    </div>

    <!-- Filters -->
    <div class="filters">
      <p><strong>Nearby Parking</strong></p>
      <p>Real-time availability within Melbourne CBD</p>
      
      <div class="filter-controls">
        <div class="filter-group">
          <label for="distanceFilter">Distance:</label>
          <select id="distanceFilter">
            <option value="2">Within 2 km</option>
            <option value="1">Within 1 km</option>
            <option value="0.5">Within 0.5 km</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="sortFilter">Sort by:</label>
          <select id="sortFilter">
            <option value="availability">Availability (Available first)</option>
            <option value="distance">Distance (Nearest first)</option>
          </select>
        </div>
      </div>
    </div>

    <div class="parking-cards-container"></div>

  </div>
</body>
</html>